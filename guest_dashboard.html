<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Guest Dashboard | Grand Vista Hotel</title>
  <link rel="stylesheet" href="style.css" />

  <style>
    .dashboard-box {
      max-width: 750px;
      margin: 2rem auto;
      background: white;
      border: 2px solid #E8D7A9;
      border-radius: 12px;
      padding: 2rem;
      box-shadow: 0 4px 20px rgba(212,175,55,0.15);
    }

    .section-title {
      font-size: 1.4rem;
      color: #d4af37;
      border-bottom: 2px solid #f1e6c9;
      padding-bottom: 4px;
      margin-top: 1.5rem;
      margin-bottom: 0.7rem;
    }

    .badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 12px;
      margin-right: 6px;
      font-size: 0.85rem;
      font-weight: bold;
      background-color: #f8f0d9;
      border: 1px solid #d4af37;
      color: #634e22;
    }

    .info-line {
      margin: 0.3rem 0;
      font-size: 1.05rem;
      color: #333;
    }

    .info-sub {
      font-size: 0.95rem;
      color: #555;
      margin: 2px 0;
    }

    .request-box {
      background: #fffdf5;
      border: 1px solid #e8d7a9;
      padding: 10px;
      margin: 8px 0;
      border-radius: 8px;
    }

    .request-status {
      font-size: 0.85rem;
      padding: 2px 8px;
      border-radius: 10px;
      display: inline-block;
      margin-left: 8px;
    }

    .status-pending { background:#fff3cd; border:1px solid #ffe58f; color:#8a6d1d; }
    .status-in-progress { background:#d1ecf1; border:1px solid #bee5eb; color:#0c5460; }
    .status-completed { background:#d4edda; border:1px solid #c3e6cb; color:#155724; }

    .timestamp {
      font-size: 0.85rem;
      color: #666;
      display: block;
      margin-top: 4px;
    }

    .request-form {
      padding: 1rem;
      background: #fffdf7;
      border: 1px solid #e8d7a9;
      border-radius: 10px;
      margin-bottom: 1.5rem;
    }

    select, input, button {
      padding: 10px;
      font-size: 1rem;
      border-radius: 8px;
      border: 1px solid #d4af37;
      width: 100%;
      margin-top: 10px;
    }

    button {
      background: #d4af37;
      color: white;
      cursor: pointer;
      transition: 0.2s;
    }

    button:hover { background: #e5c864; }

    /* CHATBOX */
    #chatButton {
      position: fixed;
      bottom: 25px;
      right: 25px;
      background: #d4af37;
      color: white;
      border: none;
      border-radius: 50%;
      width: 65px;
      height: 65px;
      cursor: pointer;
      font-size: 30px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    }

    #chatContainer {
      display: none;
      position: fixed;
      bottom: 100px;
      right: 25px;
      width: 320px;
      background: white;
      border-radius: 12px;
      border: 2px solid #d4af37;
      box-shadow: 0 4px 20px rgba(0,0,0,0.25);
    }

    #chatHeader {
      background: #d4af37;
      color: white;
      padding: 10px;
      border-radius: 10px 10px 0 0;
      font-weight: bold;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    #closeChat {
      background: none;
      border: none;
      color: white;
      font-size: 18px;
      cursor: pointer;
    }

    #chatMessages {
      height: 260px;
      overflow-y: auto;
      padding: 10px;
      font-size: 0.9rem;
    }

    .chat {
      margin: 6px 0;
      padding: 8px 10px;
      border-radius: 6px;
      max-width: 85%;
    }

    .chat.user {
      background: #e8d7a9;
      margin-left: auto;
    }

    .chat.ai {
      background: #fff3cd;
      margin-right: auto;
    }

    #chatInput {
      width: 85%;
      padding: 10px;
      border: 1px solid #d4af37;
      border-radius: 8px;
      margin: 8px;
    }

    #sendChat {
      width: 50px;
      padding: 8px;
      background: #d4af37;
      border-radius: 8px;
      color: white;
      cursor: pointer;
      border: none;
    }
  </style>
</head>

<body>

  <header class="gv-header">
    <img src="V(1).png" alt="Logo" class="gv-logo">
    <h1 id="guestNameHeader">Guest Dashboard</h1>
  </header>

  <div class="dashboard-box" id="guestInfo"></div>

  <footer>
    <p>&copy; 2025 Grand Vista Hotel</p>
  </footer>

  <!-- CHAT BUTTON -->
  <button id="chatButton">üí¨</button>

  <!-- CHATBOX -->
  <div id="chatContainer">
    <div id="chatHeader">
      AI Concierge
      <button id="closeChat">‚úñ</button>
    </div>
    <div id="chatMessages"></div>
    <div style="display:flex; padding-bottom:10px;">
      <input id="chatInput" placeholder="Ask a question..." />
      <button id="sendChat">‚û§</button>
    </div>
  </div>

<script>
/* AUTO DELETE OLD REQUESTS */
function autoDeleteOldRequests(guest) {
  const FIVE_MIN = 5 * 60 * 1000;
  const now = Date.now();

  guest.requests = guest.requests.filter(req => {
    if (req.status === "completed" && req.completedAt) {
      return (now - req.completedAt) < FIVE_MIN;
    }
    return true;
  });

  return guest;
}

function loadGuestDashboard() {
  let guest = JSON.parse(localStorage.getItem("currentGuest"));
  if (!guest) {
    alert("No guest is currently logged in.");
    window.location.href = "guest_checkin.html";
    return;
  }

  guest = autoDeleteOldRequests(guest);
  localStorage.setItem("currentGuest", JSON.stringify(guest));

  let allGuests = JSON.parse(localStorage.getItem("guests")) || [];
  const idx = allGuests.findIndex(g => g.name === guest.name && g.passcode === guest.passcode);
  if (idx !== -1) {
    allGuests[idx] = guest;
    localStorage.setItem("guests", JSON.stringify(allGuests));
  }

  document.getElementById("guestNameHeader").textContent = `Welcome, ${guest.name}!`;

  const badges = `
    ${guest.vip ? `<span class="badge">‚≠ê VIP</span>` : ""}
    ${guest.hasPet ? `<span class="badge">üêæ Pet in Room</span>` : ""}
    ${guest.earlyCheckInRequested ? `<span class="badge">‚è∞ Early Check-In</span>` : ""}
  `;

  const maskedKey = guest.key ? "****" + guest.key.slice(-4) : "Not Assigned";

  const sortedRequests = (guest.requests || []).sort((a,b)=> b.createdAt - a.createdAt);

  const requestsHTML =
    sortedRequests.length === 0
      ? `<p>No requests submitted yet.</p>`
      : sortedRequests.map(r => `
        <div class="request-box">
          <strong>${r.text}</strong>
          <span class="request-status status-${r.status}">
            ${r.status.replace("-", " ")}
          </span>
          <span class="timestamp">${r.date}</span>
        </div>
      `).join("");

  document.getElementById("guestInfo").innerHTML = `
    <h2 class="section-title">Your Stay Information</h2>

    ${badges}

    <p class="info-line"><strong>Room Number:</strong> ${guest.room}</p>
    <p class="info-line"><strong>Guests in Room:</strong> ${guest.guestsInRoom}</p>
    <p class="info-line"><strong>Room Status:</strong> ${guest.roomStatus}</p>
    <p class="info-line"><strong>Arrival Date:</strong> ${guest.arrivalDate}</p>
    <p class="info-line"><strong>Departure Date:</strong> ${guest.departureDate}</p>
    <p class="info-line"><strong>Notes:</strong> ${guest.notes}</p>

    <h2 class="section-title">Your Digital Key</h2>
    <p>
      <span id="keyValue">${maskedKey}</span>
      <button onclick="toggleKey()">Show</button>
    </p>

    <h2 class="section-title">Hotel Information</h2>
    <p class="info-sub"><strong>Wi-Fi:</strong> GrandVista_Guest</p>
    <p class="info-sub"><strong>Password:</strong> StayGolden2025</p>
    <p class="info-sub"><strong>Check-In:</strong> 3:00 PM</p>
    <p class="info-sub"><strong>Check-Out:</strong> 11:00 AM</p>
    <p class="info-sub"><strong>Housekeeping:</strong> 8 AM ‚Äì 6 PM</p>
    <p class="info-sub"><strong>Room Service:</strong> 6:30 AM ‚Äì 11:30 PM</p>
    <p class="info-sub"><strong>Spa:</strong> 9 AM ‚Äì 8 PM</p>
    <p class="info-sub"><strong>Restaurant:</strong> 7 AM ‚Äì 10 PM</p>

    <h2 class="section-title">Create a New Service Request</h2>

    <div class="request-form">
      <select id="requestType">
        <option value="">Select a Request</option>
        <option>Towels</option>
        <option>Toiletries</option>
        <option>Extra Pillows</option>
        <option>Blankets</option>
        <option>Food Delivery</option>
        <option>Wake-Up Call</option>
        <option>Other</option>
      </select>

      <input id="otherRequest" style="display:none;" placeholder="Describe your request...">

      <button onclick="submitRequest()">Submit Request</button>
    </div>

    <h2 class="section-title">Your Service Requests</h2>
    ${requestsHTML}
  `;
}

/* Toggle key visibility */
function toggleKey() {
  let guest = JSON.parse(localStorage.getItem("currentGuest"));
  const keySpan = document.getElementById("keyValue");
  const current = keySpan.textContent;
  keySpan.textContent = current.startsWith("****") ? guest.key : "****" + guest.key.slice(-4);
}

/* Submit request */
function submitRequest() {
  let guest = JSON.parse(localStorage.getItem("currentGuest"));
  let type = document.getElementById("requestType").value;
  let other = document.getElementById("otherRequest");

  if (!type) return alert("Please select a request type.");

  if (type === "Other" && !other.value.trim())
    return alert("Please describe your request.");

  if (type === "Other") type = other.value.trim();

  guest.requests.push({
    text: type,
    status: "pending",
    date: new Date().toLocaleString(),
    createdAt: Date.now(),
    completedAt: null
  });

  localStorage.setItem("currentGuest", JSON.stringify(guest));

  let allGuests = JSON.parse(localStorage.getItem("guests"));
  const idx = allGuests.findIndex(g => g.name === guest.name && g.passcode === guest.passcode);
  if (idx !== -1) {
    allGuests[idx] = guest;
    localStorage.setItem("guests", JSON.stringify(allGuests));
  }

  location.reload();
}

/* Show/hide Other field */
document.addEventListener("change", e => {
  if (e.target.id === "requestType") {
    document.getElementById("otherRequest").style.display =
      e.target.value === "Other" ? "block" : "none";
  }
});

/* CHATBOX LOGIC */
const chatBtn = document.getElementById("chatButton");
const chatBox = document.getElementById("chatContainer");
const closeChat = document.getElementById("closeChat");
const sendBtn = document.getElementById("sendChat");
const chatInput = document.getElementById("chatInput");
const chatMessages = document.getElementById("chatMessages");

chatBtn.onclick = () => chatBox.style.display = "block";
closeChat.onclick = () => chatBox.style.display = "none";

function hotelAIResponse(message) {
  const msg = message.toLowerCase();

  if (msg.includes("wifi")) return "Wi-Fi: GrandVista_Guest<br>Password: StayGolden2025";
  if (msg.includes("check out")) return "Check-out time is 11:00 AM.";
  if (msg.includes("check in")) return "Check-in begins at 3:00 PM.";
  if (msg.includes("spa")) return "The spa is open from 9 AM ‚Äì 8 PM.";
  if (msg.includes("food") || msg.includes("room service")) return "Room service runs 6:30 AM ‚Äì 11:30 PM.";
  if (msg.includes("towel") || msg.includes("pillow"))
    return "Housekeeping has been notified. Someone will arrive shortly.";

  return "I‚Äôm here to help! Could you please tell me more?";
}

sendBtn.onclick = () => {
  const msg = chatInput.value.trim();
  if (!msg) return;

  chatMessages.innerHTML += `<div class="chat user">${msg}</div>`;
  chatInput.value = "";

  setTimeout(() => {
    chatMessages.innerHTML += `<div class="chat ai">${hotelAIResponse(msg)}</div>`;
    chatMessages.scrollTop = chatMessages.scrollHeight;
  }, 300);
};

loadGuestDashboard();
</script>

</body>
</html>
