<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Guest Dashboard | Grand Vista Hotel</title>
  <link rel="stylesheet" href="style.css" />

  <style>
    .dashboard-box {
      max-width: 750px;
      margin: 2rem auto;
      background: white;
      border: 2px solid #E8D7A9;
      border-radius: 12px;
      padding: 2rem;
      box-shadow: 0 4px 20px rgba(212,175,55,0.15);
    }

    .section-title {
      font-size: 1.4rem;
      color: #d4af37;
      border-bottom: 2px solid #f1e6c9;
      padding-bottom: 4px;
      margin-top: 1.5rem;
      margin-bottom: 0.7rem;
    }

    .badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 12px;
      margin-right: 6px;
      font-size: 0.85rem;
      font-weight: bold;
      background-color: #f8f0d9;
      border: 1px solid #d4af37;
      color: #634e22;
    }

    .info-line {
      margin: 0.3rem 0;
      font-size: 1.05rem;
      color: #333;
    }

    .info-sub {
      font-size: 0.95rem;
      color: #555;
      margin: 2px 0;
    }

    .request-box {
      background: #fffdf5;
      border: 1px solid #e8d7a9;
      padding: 10px;
      margin: 8px 0;
      border-radius: 8px;
    }

    .request-status {
      font-size: 0.85rem;
      padding: 2px 8px;
      border-radius: 10px;
      display: inline-block;
      margin-left: 8px;
    }

    .status-pending { background:#fff3cd; border:1px solid #ffe58f; color:#8a6d1d; }
    .status-in-progress { background:#d1ecf1; border:1px solid #bee5eb; color:#0c5460; }
    .status-completed { background:#d4edda; border:1px solid #c3e6cb; color:#155724; }

    .timestamp {
      font-size: 0.85rem;
      color: #666;
      display: block;
      margin-top: 4px;
    }

    /* Request Form */
    .request-form {
      padding: 1rem;
      background: #fffdf7;
      border: 1px solid #e8d7a9;
      border-radius: 10px;
      margin-bottom: 1.5rem;
    }

    select, input, button {
      padding: 10px;
      font-size: 1rem;
      border-radius: 8px;
      border: 1px solid #d4af37;
      width: 100%;
      margin-top: 10px;
    }

    button {
      background: #d4af37;
      color: white;
      cursor: pointer;
      transition: 0.2s;
    }
    button:hover { background: #e5c864; }

    /* Smaller logo */
    .gv-logo {
      height: 100px !important;
    }

    /* Chatbot styles */
    #vistaChatBtn {
      position: fixed;
      bottom: 22px;
      right: 22px;
      background: #d4af37;
      color: white;
      border: none;
      padding: 14px 18px;
      border-radius: 50%;
      font-size: 22px;
      cursor: pointer;
      box-shadow: 0 4px 10px rgba(0,0,0,0.25);
      z-index: 9999;
    }

    #vistaChatWindow {
      position: fixed;
      bottom: 90px;
      right: 20px;
      width: 320px;
      height: 430px;
      background: white;
      border: 2px solid #d4af37;
      border-radius: 10px;
      display: none;
      flex-direction: column;
      overflow: hidden;
      box-shadow: 0 4px 20px rgba(0,0,0,0.25);
      z-index: 9999;
    }

    #vistaChatHeader {
      background: #d4af37;
      color: white;
      padding: 12px;
      font-size: 1.1rem;
      font-weight: bold;
      text-align: center;
    }

    #vistaChatMessages {
      flex-grow: 1;
      padding: 10px;
      overflow-y: auto;
      font-size: 0.9rem;
    }

    #vistaChatInputBox {
      padding: 10px;
      border-top: 1px solid #ddd;
      display: flex;
      gap: 5px;
    }

    #vistaChatInput {
      flex-grow: 1;
      padding: 8px;
      border-radius: 6px;
      border: 1px solid #ccc;
    }

    #vistaChatSend {
      padding: 8px 12px;
      background: #d4af37;
      border: none;
      color: white;
      border-radius: 6px;
      cursor: pointer;
    }
  </style>
</head>

<body>
  <header class="gv-header">
    <img src="V(1).png" alt="Logo" class="gv-logo">
    <h1 id="guestNameHeader">Guest Dashboard</h1>
  </header>

  <div class="dashboard-box" id="guestInfo"></div>

  <footer>
    <p>&copy; 2025 Grand Vista Hotel</p>
  </footer>

<!-- ==========================================================
     CHATBOT WIDGET
========================================================== -->
<button id="vistaChatBtn" onclick="toggleVistaChat()">üí¨</button>

<div id="vistaChatWindow">
  <div id="vistaChatHeader">Vista AI Assistant</div>

  <div id="vistaChatMessages"></div>

  <div id="vistaChatInputBox">
    <input id="vistaChatInput" type="text" placeholder="Ask Vista..." />
    <button id="vistaChatSend" onclick="sendVistaMessage()">Send</button>
  </div>
</div>

<script>
function toggleVistaChat() {
  const box = document.getElementById("vistaChatWindow");
  box.style.display = box.style.display === "flex" ? "none" : "flex";
}

function sendVistaMessage() {
  const input = document.getElementById("vistaChatInput");
  const msg = input.value.trim();
  if (!msg) return;

  addChatMessage("guest", msg);
  input.value = "";

  handleVistaAI(msg);
}

function addChatMessage(sender, text) {
  const box = document.getElementById("vistaChatMessages");
  const div = document.createElement("div");
  div.style.margin = "6px 0";

  div.innerHTML =
    sender === "guest"
      ? `<div style="text-align:right;"><strong>You:</strong> ${text}</div>`
      : `<div><strong>Vista:</strong> ${text}</div>`;

  box.appendChild(div);
  box.scrollTop = box.scrollHeight;
}

/* AI BEHAVIOR */
function handleVistaAI(message) {
  let guest = JSON.parse(localStorage.getItem("currentGuest"));

  // Simple examples (can add MUCH more)
  if (/wifi|internet/i.test(message)) {
    addChatMessage("ai", "Our Wi-Fi network is <strong>GrandVista_Guest</strong> and the password is <strong>StayGolden2025</strong>.");
    return;
  }

  if (/key|digital/i.test(message)) {
    addChatMessage("ai", `Your digital key is: <strong>${guest.key}</strong>.`);
    return;
  }

  if (/request|towel|pillows|blanket/i.test(message)) {
    addChatMessage("ai", "To create a new service request, scroll to the 'New Service Request' section of this page!");
    return;
  }

  addChatMessage("ai", "I'm here to help! You can ask about Wi-Fi, digital keys, room requests, hotel services, and more.");
}
</script>

<!-- ==========================================================
     ORIGINAL GUEST DASHBOARD LOGIC
========================================================== -->
<script>
function autoDeleteOldRequests(guest) {
  const FIVE_MIN = 5 * 60 * 1000;
  const now = Date.now();

  guest.requests = guest.requests.filter(req => {
    if (req.status === "completed" && req.completedAt) {
      return (now - req.completedAt) < FIVE_MIN;
    }
    return true;
  });

  return guest;
}

function loadGuestDashboard() {
  let guest = JSON.parse(localStorage.getItem("currentGuest"));
  if (!guest) {
    alert("No guest is currently logged in.");
    window.location.href = "guest_checkin.html";
    return;
  }

  guest = autoDeleteOldRequests(guest);
  localStorage.setItem("currentGuest", JSON.stringify(guest));

  let allGuests = JSON.parse(localStorage.getItem("guests")) || [];
  const idx = allGuests.findIndex(g => g.name === guest.name && g.passcode === guest.passcode);
  if (idx !== -1) {
    allGuests[idx] = guest;
    localStorage.setItem("guests", JSON.stringify(allGuests));
  }

  document.getElementById("guestNameHeader").textContent = `Welcome, ${guest.name}!`;

  const badges = `
    ${guest.vip ? `<span class="badge">‚≠ê VIP</span>` : ""}
    ${guest.hasPet ? `<span class="badge">üêæ Pet in Room</span>` : ""}
    ${guest.earlyCheckInRequested ? `<span class="badge">‚è∞ Early Check-In</span>` : ""}
  `;

  const maskedKey = guest.key ? "****" + guest.key.slice(-4) : "Not Assigned";

  const sortedRequests = (guest.requests || [])
    .sort((a, b) => b.createdAt - a.createdAt);

  const requestsHTML =
    sortedRequests.length === 0
      ? `<p>No requests submitted yet.</p>`
      : sortedRequests.map(r => `
        <div class="request-box">
          <strong>${r.text}</strong>
          <span class="request-status status-${r.status}">${r.status}</span>
          <span class="timestamp">${r.date}</span>
        </div>
      `).join("");

  document.getElementById("guestInfo").innerHTML = `
    <h2 class="section-title">Your Stay Information</h2>

    ${badges}

    <p class="info-line"><strong>Room Number:</strong> ${guest.room}</p>
    <p class="info-line"><strong>Guests in Room:</strong> ${guest.guestsInRoom}</p>
    <p class="info-line"><strong>Room Status:</strong> ${guest.roomStatus}</p>
    <p class="info-line"><strong>Arrival Date:</strong> ${guest.arrivalDate}</p>
    <p class="info-line"><strong>Departure Date:</strong> ${guest.departureDate}</p>
    <p class="info-line"><strong>Notes:</strong> ${guest.notes}</p>

    <h2 class="section-title">Your Digital Key</h2>
    <p>
      <span id="keyValue">${maskedKey}</span>
      <button onclick="toggleKey()">Show</button>
    </p>

    <h2 class="section-title">Hotel Information</h2>
    <p class="info-sub"><strong>Wi-Fi:</strong> GrandVista_Guest / StayGolden2025</p>
    <p class="info-sub"><strong>Check-In:</strong> 3:00 PM</p>
    <p class="info-sub"><strong>Check-Out:</strong> 11:00 AM</p>
    <p class="info-sub"><strong>Housekeeping:</strong> 8 AM ‚Äì 6 PM</p>
    <p class="info-sub"><strong>Room Service:</strong> 6:30 AM ‚Äì 11:30 PM</p>
    <p class="info-sub"><strong>Spa:</strong> 9 AM ‚Äì 8 PM</p>
    <p class="info-sub"><strong>Restaurant:</strong> 7 AM ‚Äì 10 PM</p>

    <h2 class="section-title">Create a New Service Request</h2>

    <div class="request-form">
      <select id="requestType">
        <option value="">Select a Request</option>
        <option>Towels</option>
        <option>Toiletries</option>
        <option>Extra Pillows</option>
        <option>Blankets</option>
        <option>Food Delivery</option>
        <option>Wake-Up Call</option>
        <option>Other</option>
      </select>

      <input id="otherRequest" style="display:none;" placeholder="Describe your request...">

      <button onclick="submitRequest()">Submit Request</button>
    </div>

    <h2 class="section-title">Your Service Requests</h2>
    ${requestsHTML}
  `;
}

function toggleKey() {
  let guest = JSON.parse(localStorage.getItem("currentGuest"));
  const keySpan = document.getElementById("keyValue");
  const current = keySpan.textContent;

  keySpan.textContent = current.startsWith("****")
    ? guest.key
    : "****" + guest.key.slice(-4);
}

function submitRequest() {
  let guest = JSON.parse(localStorage.getItem("currentGuest"));
  let type = document.getElementById("requestType").value;
  let other = document.getElementById("otherRequest");

  if (type === "") {
    alert("Please select a request type.");
    return;
  }

  if (type === "Other") {
    if (!other.value.trim()) {
      alert("Please describe your request.");
      return;
    }
    type = other.value.trim();
  }

  const newReq = {
    text: type,
    status: "pending",
    date: new Date().toLocaleString(),
    createdAt: Date.now(),
    completedAt: null
  };

  guest.requests.push(newReq);

  localStorage.setItem("currentGuest", JSON.stringify(guest));

  let allGuests = JSON.parse(localStorage.getItem("guests")) || [];
  const idx = allGuests.findIndex(g => g.name === guest.name && g.passcode === guest.passcode);
  if (idx !== -1) {
    allGuests[idx] = guest;
    localStorage.setItem("guests", JSON.stringify(allGuests));
  }

  location.reload();
}

document.addEventListener("change", function(e) {
  if (e.target.id === "requestType") {
    document.getElementById("otherRequest").style.display =
      e.target.value === "Other" ? "block" : "none";
  }
});

loadGuestDashboard();
</script>

</body>
</html>
